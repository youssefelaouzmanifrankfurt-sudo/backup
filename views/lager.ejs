<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lagerbestand | LagerModul</title>
    
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/lager.css">
    <link rel="stylesheet" href="/css/lager_styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <style>
        /* Spezifische Styles fÃ¼r die Scan-Leiste */
        .scan-controls { background:#1e293b; padding:15px; border-radius:10px; border:1px solid #334155; margin-bottom: 20px; }
        .mode-btn { flex:1; padding:10px; border:1px solid #475569; background:#0f172a; color:#94a3b8; cursor:pointer; transition:all 0.2s; font-weight:600; font-size: 0.9rem; }
        .mode-btn.active { background:#3b82f6; color:white; border-color:#3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        .mode-btn:first-child { border-radius: 6px 0 0 6px; }
        .mode-btn:last-child { border-radius: 0 6px 6px 0; }
        
        .mode-btn-sell.active { background:#ef4444; border-color:#ef4444; box-shadow: 0 0 10px rgba(239,68,68,0.5); }
        .mode-btn-inv.active { background:#10b981; border-color:#10b981; box-shadow: 0 0 10px rgba(16,185,129,0.5); }
        .mode-btn-add.active { background:#f59e0b; border-color:#f59e0b; box-shadow: 0 0 10px rgba(245,158,11,0.5); }

        /* Verkauf Modal Styles */
        #sell-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center; }
        #sell-modal.active { display:flex; }
        .sell-box { background:#1e293b; padding:30px; border-radius:12px; width:90%; max-width:400px; text-align:center; border:2px solid #ef4444; color:white; }
    </style>
</head>
<body>

    <%- include('partials/nav') %>

    <div class="main-content">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h1>ðŸ“¦ Lagerbestand</h1>
            <div style="font-size:0.8rem; color:#94a3b8; text-align:right;">
                <span id="stat-total">0</span> Artikel<br>
                <span id="stat-total-value">0,00 â‚¬</span> (EK)
            </div>
        </div>

        <div class="scan-controls">
            <div style="display:flex; margin-bottom:15px; border-radius:6px; overflow:hidden;">
                <button onclick="window.ScanCtrl.setMode('search')" id="mode-search" class="mode-btn active">
                    <i class="fas fa-search"></i> Suche
                </button>
                <button onclick="window.ScanCtrl.setMode('sell')" id="mode-sell" class="mode-btn mode-btn-sell">
                    <i class="fas fa-shopping-cart"></i> Verkauf
                </button>
                <button onclick="window.ScanCtrl.setMode('inventory')" id="mode-inventory" class="mode-btn mode-btn-inv">
                    <i class="fas fa-boxes"></i> Inventur
                </button>
                <button onclick="window.ScanCtrl.setMode('insert')" id="mode-insert" class="mode-btn mode-btn-add">
                    <i class="fas fa-plus"></i> Inserieren
                </button>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <div style="flex-grow:1; display:flex; gap:5px; min-width:200px;">
                    <input type="text" id="main-scan-input" placeholder="EAN / Code scannen oder tippen..." 
                           style="width:100%; padding:12px; border-radius:6px; border:1px solid #475569; background:#0f172a; color:white; font-size:1.1rem;">
                    <button onclick="window.ScanCtrl.triggerManual()" class="btn-secondary" style="padding:0 15px;">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <div style="display:flex; gap:10px; width:100%; md:width:auto;">
                    <button onclick="window.ScanCtrl.startQR()" class="btn-primary" style="flex:1; background:#3b82f6; color:white;">
                        <i class="fas fa-qrcode"></i> Scan
                    </button>
                    <button onclick="window.ScanCtrl.triggerOCR()" class="btn-primary" style="flex:1; background:#8b5cf6; color:white;">
                        <i class="fas fa-camera"></i> Foto (OCR)
                    </button>
                </div>
                
                <input type="file" id="global-cam-input" accept="image/*" capture="environment" style="display:none;">
            </div>
        </div>

        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <input type="text" id="inp-search" onkeyup="window.View.filterStock()" placeholder="ðŸ” Liste lokal filtern..." 
                   style="flex:1; padding:10px; border-radius:6px; border:1px solid #334155; background:#1e293b; color:white;">
            <button onclick="window.openCreateModal()" class="btn-primary" style="background:#2563eb; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">
                + Neu
            </button>
        </div>

        <div class="table-wrapper" style="overflow-x: auto; background:#1e293b; border-radius:8px; border:1px solid #334155;">
            <table style="width:100%; border-collapse:collapse; color:white; min-width:600px;">
                <thead>
                    <tr style="background:#0f172a; border-bottom:1px solid #334155; text-align:left;">
                        <th style="padding:15px; color:#94a3b8;">Artikel / Name</th>
                        <th style="padding:15px; color:#94a3b8;">Ort</th>
                        <th style="padding:15px; color:#94a3b8;">Menge</th>
                        <th style="padding:15px; color:#94a3b8;">Preis (EK)</th>
                        <th style="padding:15px; color:#94a3b8;">Markt</th>
                        <th style="padding:15px; color:#94a3b8;">Status</th>
                        <th style="padding:15px; text-align:right; color:#94a3b8;">Aktionen</th>
                    </tr>
                </thead>
                <tbody id="stock-body">
                    <tr>
                        <td colspan="7" style="text-align:center; padding:50px; color:#94a3b8;">
                            <div class="spinner"></div><br>Lade Daten...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="sell-modal">
        <div class="sell-box">
            <h2 style="margin-top:0;">ðŸ›’ Artikel verkaufen</h2>
            <div id="sell-preview" style="margin:20px 0; font-size:1.1rem; color:#cbd5e1;"></div>
            
            <div style="font-size:3rem; font-weight:bold; margin-bottom:20px; color:#ef4444;">
                -1 <span style="font-size:1rem; color:#94a3b8;">StÃ¼ck</span>
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="document.getElementById('sell-modal').classList.remove('active')" 
                        style="padding:12px 20px; border-radius:6px; border:none; background:#475569; color:white; cursor:pointer;">
                    Abbrechen
                </button>
                <button id="btn-confirm-sell" 
                        style="padding:12px 20px; border-radius:6px; border:none; background:#ef4444; color:white; font-weight:bold; cursor:pointer;">
                    Verkaufen
                </button>
            </div>
        </div>
    </div>

    <%- include('partials/lager_modals') %>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script src="/js/lager/view.js"></script>
    <script src="/js/lager/printer.js"></script>
    <script src="/js/lager/controller-core.js"></script>   
    <script src="/js/lager/controller-search.js"></script> 
    <script src="/js/lager/controller-match.js"></script>  
    <script src="/js/lager/controller-stock.js"></script>  
    
    <script src="/js/lager/controller-scan.js"></script>   

    <script src="/js/lager/main.js"></script>

</body>
</html>